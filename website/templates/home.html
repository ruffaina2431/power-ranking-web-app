{% extends "base.html" %}
{% block title %}E-Sports Tournament Hub{% endblock %}
{% block content %}

<script>
$(document).ready(function() {
    $('#teamRegistrationModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var tournamentLocation = button.data('tournament-location');
        var modal = $(this);
        modal.find('#tournamentLocation').val(tournamentLocation);
    });
});

function changeCategory(category) {
    window.location.href = '?category=' + encodeURIComponent(category);
}

function searchGame() {
    var searchTerm = document.getElementById('gameSearch').value.trim();
    if (searchTerm) {
        // Store the current search term in session storage (original case for display)
        sessionStorage.setItem('lastSearchTerm', searchTerm);
        window.location.href = '?category=' + encodeURIComponent(searchTerm);
    } else {
        document.getElementById('searchFeedback').style.display = 'block';
        document.getElementById('searchFeedback').textContent = 'Please enter a game name to search';
        setTimeout(() => {
            document.getElementById('searchFeedback').style.display = 'none';
        }, 3000);
    }
}

function sortTable(sortBy) {
    var currentUrl = new URL(window.location);
    var currentSort = currentUrl.searchParams.get('sort');
    var currentOrder = currentUrl.searchParams.get('order') || 'asc';

    var newOrder = 'asc';
    if (currentSort === sortBy && currentOrder === 'asc') {
        newOrder = 'desc';
    }

    currentUrl.searchParams.set('sort', sortBy);
    currentUrl.searchParams.set('order', newOrder);
    window.location.href = currentUrl.toString();
}
</script>

<div class="container mt-4">
    <!-- Hero Section -->
    <div class="jumbotron text-center bg-dark text-white">
        <h1 class="display-4">KDM E-Sports Tournament Power Rankings</h1>
        <p class="lead">Compete in our upcoming tournaments and climb the ranks!</p>
    </div>

    <!-- Game Search Section -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h3>Search Game Categories</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <input type="text" class="form-control" id="gameSearch" placeholder="Enter game name (e.g., VALORANT, Mobile Legends)" onkeypress="if(event.key === 'Enter') searchGame()">
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-primary btn-block" onclick="searchGame()">Search</button>
                </div>
            </div>
            <div class="mt-3">
                <p class="text-muted">Available categories: {% for cat in categories %}{{ cat }}{% if not loop.last %}, {% endif %}{% endfor %}</p>
                <div id="searchFeedback" class="alert alert-warning mt-2" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Check for search results on page load
        document.addEventListener('DOMContentLoaded', function() {
            var lastSearchTerm = sessionStorage.getItem('lastSearchTerm');
            var teamsTable = document.querySelector('.table tbody');
            var noTeamsRow = teamsTable.querySelector('tr td[colspan="4"]');
            
            if (lastSearchTerm && noTeamsRow) {
                document.getElementById('searchFeedback').style.display = 'block';
                document.getElementById('searchFeedback').textContent = 'No teams found for "' + lastSearchTerm + '". Try checking the game name spelling or try a different game.';
                // Highlight available categories
                document.querySelector('.text-muted').style.fontWeight = 'bold';
                sessionStorage.removeItem('lastSearchTerm');
            } else if (lastSearchTerm) {
                sessionStorage.removeItem('lastSearchTerm');
            }

            // Set the search input value to the last search
            if (lastSearchTerm) {
                document.getElementById('gameSearch').value = lastSearchTerm;
            }
        });
    </script>

    <!-- Power Rankings Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2>Current Power Rankings - {{ current_category }}</h2>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th><a href="#" onclick="sortTable('rank')" class="text-black">Rank {% if sort_by == 'rank' %}{% if order == 'asc' %}↑{% else %}↓{% endif %}{% endif %}</a></th>
                            <th><a href="#" onclick="sortTable('name')" class="text-black">Team Name {% if sort_by == 'name' %}{% if order == 'asc' %}↑{% else %}↓{% endif %}{% endif %}</a></th>
                            <th><a href="#" onclick="sortTable('points')" class="text-black">Points {% if sort_by == 'points' %}{% if order == 'asc' %}↑{% else %}↓{% endif %}{% endif %}</a></th>
                            <th><a href="#" onclick="sortTable('wins')" class="text-black">Tournament Wins {% if sort_by == 'wins' %}{% if order == 'asc' %}↑{% else %}↓{% endif %}{% endif %}</a></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for team in teams %}
                        <tr>
                            <td>{{ team.rank or 'Unranked' }}</td>
                            <td>{{ team.name }}</td>
                            <td>{{ team.points }}</td>
                            <td>{{ team.wins }}</td>
                        </tr>
                        {% endfor %}
                        {% if not teams %}
                        <tr>
                            <td colspan="4" class="text-center">No teams found for this category.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tournament Registration Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2>Upcoming Tournaments</h2>
        </div>
        <div class="card-body">
            {% if tournaments %}
            <div style="max-height: 700px; overflow-y: auto;">
                {% for tournament in tournaments %}
                <div class="card mb-3">
                    <div class="card-header {% if tournament.location == 'point-a' %}bg-success{% else %}bg-info{% endif %} text-white">
                        <h5>{{ tournament.name }}</h5>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">Date: {{ tournament.date.strftime('%B %d, %Y') }}</h6>
                        <p class="card-text">
                            Location: {{ tournament.location|title }}<br>
                            Max Teams: {{ tournament.max_teams }}<br>
                            Requirements:
                            <ul class="mb-2">
                                <li>Complete team roster (5 players)</li>
                                <li>Team name</li>
                                <li>Team captain contact information</li>
                            </ul>
                        </p>
                        {% if current_user.is_authenticated %}
                        <button type="button" class="btn {% if tournament.location == 'point-a' %}btn-success{% else %}btn-info{% endif %} btn-block" data-toggle="modal" data-target="#teamRegistrationModal" data-tournament-location="{{ tournament.location }}">Register Team</button>
                        {% else %}
                        <a href="/login" class="btn {% if tournament.location == 'point-a' %}btn-success{% else %}btn-info{% endif %} btn-block">Login to Register</a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center">
                <p class="text-muted">No upcoming tournaments available at the moment.</p>
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('views.tournament_create') }}" class="btn btn-primary">Create Tournament</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>


</div>

<!-- Team Registration Modal -->
<div class="modal fade" id="teamRegistrationModal" tabindex="-1" role="dialog" aria-labelledby="teamRegistrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamRegistrationModalLabel">Register Your Team</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('views.register_team') }}">
                    <div class="form-group">
                        <label for="teamName">Team Name</label>
                        <input type="text" class="form-control" id="teamName" name="teamName" required>
                    </div>
                    <div class="form-group">
                        <label for="captainName">Team Captain Name</label>
                        <input type="text" class="form-control" id="captainName" name="captainName" required>
                    </div>
                    <div class="form-group">
                        <label for="captainEmail">Captain Email</label>
                        <input type="email" class="form-control" id="captainEmail" name="captainEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="captainPhone">Captain Phone Number</label>
                        <input type="tel" class="form-control" id="captainPhone" name="captainPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Team Members</label>
                        {% for i in range(1, 6) %}
                        <input type="text" class="form-control mb-2" name="player{{i}}" placeholder="Player {{i}} Name" required>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="tournamentLocation" name="tournamentLocation" value="">
                    <button type="submit" class="btn btn-warning btn-block">Register Team</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}
